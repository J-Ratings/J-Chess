<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>J-Chess</title>
  <!-- Board CSS from CDN -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/css/chessboard.min.css"
  />
  <style>
    body {
      font-family: sans-serif;
      padding: 30px;
      text-align: center;
    }
    #board {
      width: 400px;
      margin: 20px auto;
    }
    #controls {
      margin-top: 20px;
    }
    #status {
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>J-Chess</h1>
  <div id="board"></div>

  <div id="controls">
    Engine depth:
    <input type="range" id="depth" min="1" max="20" value="10">
    <span id="depthVal">10</span>
    <button id="newGame">New game</button>
  </div>
  <div id="status"></div>

  <!-- Dependencies -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/js/chessboard.min.js">
  </script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js">
  </script>

  <script>
  $(function() {
    // 1) Spin up the engine as a Worker
    const engine = new Worker(
      'https://cdn.jsdelivr.net/npm/stockfish@16.1.1/src/stockfish-umd.js'
    );
    engine.postMessage('uci');
    engine.postMessage('isready');

    // 2) Set up game logic
    const game = new Chess();

    // 3) Initialise the board
    const board = Chessboard('board', {
      draggable: true,
      position: 'start',
      pieceTheme:
        'https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/img/chesspieces/wikipedia/{piece}.png',
      onDragStart: (source, piece) => {
        // Prevent moving when game over or wrong colour
        if (game.game_over() ||
            (game.turn() === 'w' && piece[0] !== 'w') ||
            (game.turn() === 'b' && piece[0] !== 'b')) {
          return false;
        }
      },
      onDrop: (source, target) => {
        const move = game.move({
          from: source,
          to: target,
          promotion: 'q'
        });
        // Illegal move
        if (!move) return 'snapback';
        board.position(game.fen());
        updateStatus();
        window.setTimeout(engineMove, 200);
      },
      onSnapEnd: () => {
        board.position(game.fen());
      }
    });

    // 4) Engine â†’ play function
    engine.onmessage = ({ data }) => {
      if (data.startsWith('bestmove')) {
        const mv = data.split(' ')[1];
        game.move({
          from: mv.substr(0, 2),
          to: mv.substr(2, 2),
          promotion: 'q'
        });
        board.position(game.fen());
        updateStatus();
      }
    };

    // 5) Send position to engine
    function engineMove() {
      engine.postMessage('position fen ' + game.fen());
      engine.postMessage('go depth ' + $('#depth').val());
    }

    // 6) Update status display
    function updateStatus() {
      if (game.in_checkmate()) {
        $('#status').text(
          'Checkmate! ' +
          (game.turn() === 'w' ? 'Black' : 'White') +
          ' wins.'
        );
      } else if (game.in_draw()) {
        $('#status').text('Draw!');
      } else {
        let s = (game.turn() === 'w' ? 'White' : 'Black') + ' to move';
        if (game.in_check()) s += ', in check';
        $('#status').text(s);
      }
    }

    // 7) Controls
    $('#depth').on('input change', function() {
      $('#depthVal').text(this.value);
    });
    $('#newGame').click(function() {
      game.reset();
      board.start();
      updateStatus();
    });

    // 8) Kick it off
    updateStatus();
  });
  </script>
</body>
</html>
