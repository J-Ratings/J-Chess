<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>J-Chess + Stockfish</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="chessboardjs-1.0.0/css/chessboard-1.0.0.min.css" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: sans-serif;
      background: #f5f5f5;
      text-align: center;
    }
    #controls {
      margin: 15px 0;
    }
    #controls > * {
      margin: 0 8px;
      padding: 8px 16px;
      font-size: 1em;
      cursor: pointer;
    }

    /* Board container & spinner overlay */
    #board-container {
      position: relative;
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
      aspect-ratio: 1;
    }
    #board {
      width: 100%;
      height: 100%;
    }
    #loadingSpinner {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 50px;
      height: 50px;
      border: 6px solid #eee;
      border-top: 6px solid #0077cc;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      transform: translate(-50%, -50%);
      display: none;
      z-index: 10;
      pointer-events: none;
    }
    @keyframes spin {
      0%   { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* Stats below board */
    #stats {
      margin-top: 12px;
      text-align: center;
    }
    #stats h2 {
      margin: 6px 0;
      font-size: 1.2em;
      font-weight: 600;
    }

    /* Highlight styles */
    .highlight-white {
      box-shadow: inset 0 0 3px 3px yellow;
    }
    .highlight-black {
      box-shadow: inset 0 0 3px 3px blue;
    }
  </style>
</head>
<body>
  <h1>J-Chess</h1>

  <div id="controls">
    <button id="randomiseBtn">Generate Position</button>
    <button id="fairBtn">Generate Fair Position</button>
    <label for="levelSelect">Level:</label>
    <select id="levelSelect">
      <option value="1">Lv. 1</option>
      <option value="2">Lv. 2</option>
      <option value="3">Lv. 3</option>
      <option value="4">Lv. 4</option>
      <option value="5" selected>Lv. 5</option>
      <option value="6">Lv. 6</option>
      <option value="7">Lv. 7</option>
      <option value="8">Lv. 8</option>
      <option value="9">Lv. 9</option>
      <option value="10">Lv. 10</option>
    </select>
  </div>

  <div id="board-container">
    <div id="board"></div>
    <div id="loadingSpinner"></div>
  </div>

  <div id="stats">
    <h2>8.3 million starting positions</h2>
    <h2>2.5 million fair starting positions</h2>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="chessboardjs-1.0.0/js/chessboard-1.0.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üü¢ DOM ready');

      // Node limits
      const nodesByLevel = {
        1:    1,    2:   10,   3:  1000,  4:  5000,
        5:10000,   6:50000,  7:100000, 8:250000,
        9:500000, 10:1000000
      };

      // Skill‚Äêlevel mapping
      const levelToSkill = {
        1:1,2:3,3:5,4:10,5:12,
        6:14,7:16,8:18,9:20,10:20
      };

      let currentLevel = 5, searchingFair = false;
      let engine, evalEngine;

      try {
        engine     = new Worker('engine/stockfish-17-lite-single.js');
        evalEngine = new Worker('engine/stockfish-17-lite-single.js');
      } catch (e) {
        console.warn('‚ö†Ô∏è Stockfish failed to load', e);
        return;
      }

      // Elo cap helper
      function eloForLevel(l) {
        const min=1350, max9=2999;
        return l<10
          ? Math.round(min + ((l-1)/8)*(max9-min))
          : null;
      }

      // Highlight helpers
      const $board = $('#board');
      const squareClass = 'square-55d63';
      let squareToHighlight = null, colorToHighlight = null;
      function onMoveEnd() {
        if (squareToHighlight && colorToHighlight) {
          $board
            .find('.square-' + squareToHighlight)
            .addClass('highlight-' + colorToHighlight);
        }
      }

      // Init UCI
      function initEngine(w, name) {
        w.postMessage('uci');
        w.addEventListener('message', ({data}) => {
          const line = data.trim();
          if (line==='uciok') {
            w.postMessage('ucinewgame');
            if (currentLevel<10) {
              w.postMessage('setoption name UCI_LimitStrength value true');
              w.postMessage('setoption name UCI_Elo value ' + eloForLevel(currentLevel));
              w.postMessage('setoption name Skill Level value ' + levelToSkill[currentLevel]);
            } else {
              w.postMessage('setoption name UCI_LimitStrength value false');
            }
            w.postMessage('isready');
          }
          if (line==='readyok') console.log(`‚úÖ ${name} ready`);
        });
      }
      initEngine(engine, 'Play-engine');
      initEngine(evalEngine, 'Eval-engine');

      $('#levelSelect').on('change', function(){
        currentLevel = +this.value;
        const elo = eloForLevel(currentLevel);
        const skill = levelToSkill[currentLevel];
        [engine,evalEngine].forEach(w=>{
          if(currentLevel<10){
            w.postMessage('setoption name UCI_LimitStrength value true');
            w.postMessage('setoption name UCI_Elo value ' + elo);
            w.postMessage('setoption name Skill Level value ' + skill);
          } else {
            w.postMessage('setoption name UCI_LimitStrength value false');
          }
        });
        console.log(`üéö Level ${currentLevel} ‚Üí Skill ${skill}` + (elo?` (Elo‚âà${elo})`:' (Full)'));
      });

      // Board & game
      const game = new Chess();
      const board = Chessboard('board', {
        draggable: true,
        position: 'start',
        pieceTheme: 'chessboardjs-1.0.0/img/chesspieces/wikipedia/{piece}.png',
        onDragStart, onDrop, onSnapEnd, onMoveEnd
      });
      $(window).resize(board.resize);

      function onDragStart(src,piece){
        return !(game.game_over()||piece[0]!=='w');
      }
      function onSnapEnd(){
        board.position(game.fen(), false);
      }

      function onDrop(src,tgt){
        // highlight from-square
        $board.find('.'+squareClass).removeClass('highlight-white highlight-black');
        $board.find('.square-'+src).addClass('highlight-white');
        squareToHighlight = tgt;
        colorToHighlight = 'white';

        const mv = game.move({from:src,to:tgt,promotion:'q'});
        if(!mv) return 'snapback';
        console.log('ü§ö You played:', mv.san);

        setTimeout(()=>{
          engine.postMessage('position fen '+game.fen());
          const nodes = nodesByLevel[currentLevel];
          engine.postMessage('go nodes '+nodes);
        },250);
      }

      engine.addEventListener('message',({data})=>{
        const line = data.trim();
        if(line.startsWith('bestmove') && !searchingFair){
          const uci = line.split(' ')[1],
                from = uci.slice(0,2),
                to   = uci.slice(2,4);
          // highlight engine move
          $board.find('.'+squareClass).removeClass('highlight-white highlight-black');
          $board.find('.square-'+from).addClass('highlight-black');
          squareToHighlight = to;
          colorToHighlight = 'black';

          const res = game.move({from,to,promotion:'q'});
          if(res) board.position(game.fen(), false);
        }
      });

      // Other controls unchanged...
      // ...fair search, randomise, etc., as before, omitted for brevity...
    });
  </script>
</body>
</html>
